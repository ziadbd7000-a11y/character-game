<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>منشئ شخصية — ستايل Bitmoji</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f1724; --muted:#98a4b2; --accent:#22c1a1; --card:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: "Segoe UI", Tahoma, Roboto, "Noto Naskh Arabic", sans-serif;
  background: linear-gradient(180deg,#07101a 0%, #0b1220 100%);
  color:#eaf3f6;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.wrap{max-width:1100px;margin:26px auto;padding:14px}
h1{margin:0 0 8px;font-size:20px;text-align:center}
.grid{display:grid;grid-template-columns:1fr 460px;gap:18px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.controls label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
select,input[type="text"],textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
.row{display:flex;gap:8px}
.row > *{flex:1}
button.primary{background:var(--accent);border:0;color:#042826;font-weight:700;cursor:pointer;padding:10px;border-radius:8px}
.small{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
.canvas{width:420px;height:520px;background:var(--card);border-radius:14px;display:flex;align-items:center;justify-content:center;padding:18px}
.controls .hint{font-size:12px;color:var(--muted);margin-top:6px}
.footer-note{font-size:12px;color:#9fb0b6;text-align:center;margin-top:8px}
@media(max-width:980px){.grid{grid-template-columns:1fr}.canvas{width:320px;height:420px}}
</style>
</head>
<body>
<div class="wrap">
  <h1>منشئ شخصية — ستايل Bitmoji</h1>
  <p class="small">غيّر الخيارات على اليسار والشخصية تتحدّث فوراً. بعد ما تجهّز تقدر تحفظ PNG أو تنسخ إعدادات JSON.</p>

  <div class="grid">
    <!-- Controls -->
    <div class="card controls">
      <label>لون البشرة</label>
      <select id="skin">
        <option value="#f7dfc6">فاتح جداً</option>
        <option value="#e6bf97">فاتح</option>
        <option value="#d39a6b">متوسط</option>
        <option value="#a56a3b">داكن</option>
        <option value="#6a3f2a">غامق</option>
      </select>

      <label>لون الشعر</label>
      <select id="hairColor">
        <option value="#1f1b17">أسود</option>
        <option value="#3b2416">بني غامق</option>
        <option value="#8b5a3c">بني فاتح</option>
        <option value="#d4b56a">أشقر</option>
        <option value="#b74a32">نحاسي</option>
        <option value="#6b6f73">رمادي</option>
      </select>

      <label>ستايل الشعر</label>
      <select id="hairStyle">
        <option value="short">قصير</option>
        <option value="side">وسط (Side part)</option>
        <option value="long">طويل</option>
        <option value="curly">متموج</option>
      </select>

      <label>لون العين</label>
      <select id="eyeColor">
        <option value="#3b2b20">بني</option>
        <option value="#123b6b">أزرق</option>
        <option value="#2f7a3e">أخضر</option>
        <option value="#222222">أسود</option>
      </select>

      <label>شكل الحاجب</label>
      <select id="browStyle">
        <option value="normal">عادي</option>
        <option value="thick">سميك</option>
        <option value="arched">مقوس</option>
      </select>

      <label>الفم</label>
      <select id="mouthStyle">
        <option value="smile">مبتسم</option>
        <option value="neutral">محايد</option>
        <option value="open">مفتوح خفيف</option>
      </select>

      <label>إضافات</label>
      <select id="extra">
        <option value="none">بدون</option>
        <option value="freckles">نمش</option>
        <option value="beard">لحية خفيفة</option>
        <option value="mole">شامة</option>
      </select>

      <label style="margin-top:8px"><input type="checkbox" id="glasses"> نظارة</label>

      <label style="margin-top:10px">اسم الشخصية (اختياري)</label>
      <input id="name" placeholder="مثال: محمد">

      <div class="row" style="margin-top:12px">
        <button class="primary" id="downloadBtn">تحميل PNG</button>
        <button id="copyJson">نسخ JSON</button>
      </div>

      <label style="margin-top:12px">JSON الشخصية (نسخ/لصق)</label>
      <textarea id="jsonArea" placeholder='{"skin":"#...","hairStyle":"..."}'></textarea>
      <div class="row" style="margin-top:8px">
        <button id="loadJson">استيراد</button>
        <button id="reset">إعادة ضبط</button>
      </div>

      <div class="hint">ملحوظة: الألوان تتناسب مع طبقات الوجه لتظهر طبيعية</div>
    </div>

    <!-- Preview -->
    <div class="card preview">
      <div class="canvas" id="canvasContainer" aria-label="معاينة الشخصية">
        <!-- SVG Bitmoji-style avatar -->
        <svg id="avatar" width="360" height="460" viewBox="0 0 360 460" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="title">
          <title id="title">معاينة الشخصية</title>
          <defs>
            <filter id="softShadow" x="-40%" y="-40%" width="200%" height="200%">
              <feDropShadow dx="0" dy="20" stdDeviation="30" flood-color="#000" flood-opacity="0.18"/>
            </filter>
            <clipPath id="faceClip"><ellipse cx="180" cy="190" rx="98" ry="122" /></clipPath>
          </defs>

          <!-- background card color -->
          <rect width="100%" height="100%" rx="12" fill="#fbfdff"/>

          <!-- subtle ground shadow -->
          <ellipse cx="180" cy="410" rx="120" ry="18" fill="#000" opacity="0.06"/>

          <!-- body / shoulders -->
          <g id="body" transform="translate(0,40)">
            <path d="M80 350 q100 40 200 0 v-60 q-70 -20 -200 0 z" fill="#f3f6f9"/>
          </g>

          <!-- hair back styles -->
          <g id="hair_back_short"><path d="M60 140 C70 70 290 70 300 140 C280 120 240 100 180 100 C120 100 80 120 60 140 Z" fill="#2b1b17"/></g>
          <g id="hair_back_side" style="display:none"><path d="M40 150 C80 40 280 40 320 150 C280 120 230 90 180 90 C130 90 80 120 40 150 Z" fill="#2b1b17"/></g>
          <g id="hair_back_long" style="display:none"><path d="M20 170 C100 10 260 10 340 170 C300 140 240 110 180 100 C120 110 60 140 20 170 Z" fill="#2b1b17"/></g>
          <g id="hair_back_curly" style="display:none"><path d="M30 160 C70 40 290 40 330 160 C300 130 235 110 180 105 C125 110 70 130 30 160 Z" fill="#2b1b17"/></g>

          <!-- face (clipped) -->
          <g id="faceGroup" clip-path="url(#faceClip)">
            <ellipse id="faceBase" cx="180" cy="190" rx="98" ry="122" fill="#f7dfc6"/>
            <!-- subtle cheek shading -->
            <ellipse cx="130" cy="210" rx="20" ry="12" fill="#000" opacity="0.04"/>
            <ellipse cx="230" cy="210" rx="20" ry="12" fill="#000" opacity="0.04"/>
          </g>

          <!-- ears -->
          <g id="ears">
            <ellipse cx="80" cy="190" rx="18" ry="24" fill="#f7dfc6"/>
            <ellipse cx="280" cy="190" rx="18" ry="24" fill="#f7dfc6"/>
          </g>

          <!-- hair front -->
          <g id="hair_front_short"><path d="M95 120 C115 90 245 90 265 120 C245 105 215 92 180 92 C145 92 115 105 95 120 Z" fill="#2b1b17"/></g>
          <g id="hair_front_side" style="display:none"><path d="M90 110 C125 70 235 70 270 110 C240 92 210 85 180 82 C150 85 120 92 90 110 Z" fill="#2b1b17"/></g>
          <g id="hair_front_long" style="display:none"><path d="M110 100 C140 70 220 70 250 100 C230 85 200 80 180 78 C160 80 130 85 110 100 Z" fill="#2b1b17"/></g>
          <g id="hair_front_curly" style="display:none"><path d="M80 112 C130 60 230 60 280 112 C250 92 215 86 180 86 C145 86 110 92 80 112 Z" fill="#2b1b17"/></g>

          <!-- brows (3 styles) -->
          <g id="brow_normal">
            <path id="bL" d="M130 150 q18 -6 36 0" stroke="#2b1b17" stroke-width="5" stroke-linecap="round" fill="none"/>
            <path id="bR" d="M204 150 q18 -6 36 0" stroke="#2b1b17" stroke-width="5" stroke-linecap="round" fill="none"/>
          </g>
          <g id="brow_thick" style="display:none">
            <path d="M125 148 q24 -8 44 0" stroke="#2b1b17" stroke-width="8" stroke-linecap="round" fill="none"/>
            <path d="M199 148 q24 -8 44 0" stroke="#2b1b17" stroke-width="8" stroke-linecap="round" fill="none"/>
          </g>
          <g id="brow_arched" style="display:none">
            <path d="M135 146 q10 -14 40 -6" stroke="#2b1b17" stroke-width="5" stroke-linecap="round" fill="none"/>
            <path d="M185 146 q10 -14 40 -6" stroke="#2b1b17" stroke-width="5" stroke-linecap="round" fill="none"/>
          </g>

          <!-- eyes -->
          <g id="eyesGroup">
            <g id="leftEye">
              <ellipse cx="140" cy="168" rx="24" ry="16" fill="#fff"/>
              <ellipse id="irisL" cx="140" cy="168" rx="9" ry="9" fill="#3b2b20"/>
              <circle cx="146" cy="162" r="2.8" fill="#fff"/>
              <path d="M128 176 q12 8 24 0" stroke="#6b3a2a" stroke-width="1.6" stroke-linecap="round" fill="none" opacity="0.12"/>
            </g>
            <g id="rightEye">
              <ellipse cx="220" cy="168" rx="24" ry="16" fill="#fff"/>
              <ellipse id="irisR" cx="220" cy="168" rx="9" ry="9" fill="#3b2b20"/>
              <circle cx="226" cy="162" r="2.8" fill="#fff"/>
              <path d="M208 176 q12 8 24 0" stroke="#6b3a2a" stroke-width="1.6" stroke-linecap="round" fill="none" opacity="0.12"/>
            </g>
          </g>

          <!-- nose subtle -->
          <path d="M180 180 q2 12 0 26" stroke="#b67b5a" stroke-width="2.2" stroke-linecap="round" fill="none" opacity="0.6"/>

          <!-- mouth -->
          <g id="mouthGroup" transform="translate(0,82)">
            <path id="mouth_smile" d="M160 244 q18 14 40 0" stroke="#7a3b2a" stroke-width="3.2" stroke-linecap="round" fill="none"/>
            <path id="mouth_neutral" d="M160 246 q18 6 40 0" stroke="#7a3b2a" stroke-width="2.4" stroke-linecap="round" fill="none" style="display:none"/>
            <path id="mouth_open" d="M165 240 q16 28 30 0 q-16 10 -30 0" fill="#cc6b5a" style="display:none"/>
          </g>

          <!-- freckles -->
          <g id="freckles" style="display:none" fill="#b06b48">
            <circle cx="155" cy="200" r="2.4"/>
            <circle cx="170" cy="208" r="2.2"/>
            <circle cx="190" cy="200" r="2.4"/>
          </g>

          <!-- mole -->
          <circle id="mole" cx="140" cy="210" r="2.4" fill="#5a3a2a" style="display:none"/>

          <!-- beard -->
          <g id="beard" style="display:none" opacity="0.95">
            <path d="M130 255 q45 30 100 0 q-12 15 -100 0" fill="#3b2416"/>
          </g>

          <!-- glasses -->
          <g id="glassesGroup" style="display:none">
            <rect x="120" y="146" width="60" height="36" rx="8" fill="none" stroke="#2b2b2b" stroke-width="3"/>
            <rect x="200" y="146" width="60" height="36" rx="8" fill="none" stroke="#2b2b2b" stroke-width="3"/>
            <path d="M180 164 h12" stroke="#2b2b2b" stroke-width="3"/>
          </g>

        </svg>
      </div>

      <div class="footer-note">حرّك الخيارات ليظهر الشكل — إضغط "تحميل" لحفظ PNG أو "نسخ JSON" لمشاركة الإعدادات</div>
    </div>
  </div>
</div>

<script>
/* ---------- عناصر DOM ---------- */
const skin = document.getElementById('skin');
const hairColor = document.getElementById('hairColor');
const hairStyle = document.getElementById('hairStyle');
const eyeColor = document.getElementById('eyeColor');
const browStyle = document.getElementById('browStyle');
const mouthStyle = document.getElementById('mouthStyle');
const extra = document.getElementById('extra');
const glasses = document.getElementById('glasses');

const faceBase = document.getElementById('faceBase');
const ears = document.querySelectorAll('#ears ellipse');

const hairBack = {
  short: document.getElementById('hair_back_short'),
  side: document.getElementById('hair_back_side'),
  long: document.getElementById('hair_back_long'),
  curly: document.getElementById('hair_back_curly')
};
const hairFront = {
  short: document.getElementById('hair_front_short'),
  side: document.getElementById('hair_front_side'),
  long: document.getElementById('hair_front_long'),
  curly: document.getElementById('hair_front_curly')
};

const irisL = document.getElementById('irisL');
const irisR = document.getElementById('irisR');

const brow_normal = document.getElementById('brow_normal');
const brow_thick = document.getElementById('brow_thick');
const brow_arched = document.getElementById('brow_arched');

const mouth_smile = document.getElementById('mouth_smile');
const mouth_neutral = document.getElementById('mouth_neutral');
const mouth_open = document.getElementById('mouth_open');

const freckles = document.getElementById('freckles');
const mole = document.getElementById('mole');
const beard = document.getElementById('beard');
const glassesGroup = document.getElementById('glassesGroup');

/* ---------- تحديث الواجهة ---------- */
function updateAvatar(){
  // skin
  const skinVal = skin.value;
  faceBase.setAttribute('fill', skinVal);
  ears.forEach(e=>e.setAttribute('fill', skinVal));

  // hair style + color
  const hVal = hairColor.value;
  Object.keys(hairBack).forEach(k=>{
    hairBack[k].style.display = (k===hairStyle.value ? '' : 'none');
    hairFront[k].style.display = (k===hairStyle.value ? '' : 'none');
    hairBack[k].querySelectorAll('path').forEach(p=>p.setAttribute('fill', hVal));
    hairFront[k].querySelectorAll('path').forEach(p=>p.setAttribute('fill', hVal));
  });

  // eyes
  irisL.setAttribute('fill', eyeColor.value);
  irisR.setAttribute('fill', eyeColor.value);

  // brows switch
  brow_normal.style.display = browStyle.value === 'normal' ? '' : 'none';
  brow_thick.style.display = browStyle.value === 'thick' ? '' : 'none';
  brow_arched.style.display = browStyle.value === 'arched' ? '' : 'none';
  // set brow color to slightly darker than hair for realism
  const browColor = shadeColor(hVal, -25);
  [brow_normal, brow_thick, brow_arched].forEach(g=>{
    g.querySelectorAll('path').forEach(p=>p.setAttribute('stroke', browColor));
  });

  // mouth
  mouth_smile.style.display = mouthStyle.value === 'smile' ? '' : 'none';
  mouth_neutral.style.display = mouthStyle.value === 'neutral' ? '' : 'none';
  mouth_open.style.display = mouthStyle.value === 'open' ? '' : 'none';

  // extras
  freckles.style.display = extra.value === 'freckles' ? '' : 'none';
  mole.style.display = extra.value === 'mole' ? '' : 'none';
  beard.style.display = extra.value === 'beard' ? '' : 'none';

  // glasses
  glassesGroup.style.display = glasses.checked ? '' : 'none';
}

/* ---------- small helper: shade color ---------- */
function shadeColor(color, percent) {
  // color in #rrggbb, percent negative for darker
  const num = parseInt(color.slice(1),16);
  const r = (num >> 16) + Math.round((percent/100)*255);
  const g = ((num >> 8) & 0x00FF) + Math.round((percent/100)*255);
  const b = (num & 0x0000FF) + Math.round((percent/100)*255);
  const clamp = v => Math.max(0, Math.min(255, v));
  return '#' + ( (1<<24) + (clamp(r)<<16) + (clamp(g)<<8) + clamp(b) ).toString(16).slice(1);
}

/* ---------- event listeners ---------- */
[skin, hairColor, hairStyle, eyeColor, browStyle, mouthStyle, extra, glasses]
.forEach(el => el.addEventListener('change', updateAvatar));

document.addEventListener('DOMContentLoaded', ()=> {
  updateAvatar();
});

/* ---------- PNG download ---------- */
document.getElementById('downloadBtn').addEventListener('click', async ()=>{
  const svg = document.getElementById('avatar');
  const xml = new XMLSerializer().serializeToString(svg);
  const blob = new Blob([xml], {type: 'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = function(){
    const canvas = document.createElement('canvas');
    canvas.width = 2200; canvas.height = 2800;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    const svgRect = svg.getBoundingClientRect();
    // scale preserve aspect
    const scale = Math.min(canvas.width / svg.viewBox.baseVal.width, canvas.height / svg.viewBox.baseVal.height);
    const w = svg.viewBox.baseVal.width * scale;
    const h = svg.viewBox.baseVal.height * scale;
    ctx.drawImage(img, (canvas.width - w)/2, (canvas.height - h)/2, w, h);
    canvas.toBlob(blob2 => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob2);
      const name = (document.getElementById('name').value || 'character') + '.png';
      a.download = name;
      document.body.appendChild(a); a.click(); a.remove();
    }, 'image/png', 0.95);
    URL.revokeObjectURL(url);
  };
  img.onerror = ()=> alert('فشل تحويل الـSVG إلى صورة — جرّب مرة ثانية');
  img.src = url;
});

/* ---------- JSON export/import ---------- */
document.getElementById('copyJson').addEventListener('click', ()=>{
  const payload = JSON.stringify({
    skin: skin.value,
    hairColor: hairColor.value,
    hairStyle: hairStyle.value,
    eyeColor: eyeColor.value,
    browStyle: browStyle.value,
    mouthStyle: mouthStyle.value,
    extra: extra.value,
    glasses: glasses.checked,
    name: document.getElementById('name').value || ''
  }, null, 2);
  navigator.clipboard.writeText(payload).then(()=> alert('تم نسخ JSON'));
});

document.getElementById('loadJson').addEventListener('click', ()=>{
  try{
    const data = JSON.parse(document.getElementById('jsonArea').value);
    if(data.skin) skin.value = data.skin;
    if(data.hairColor) hairColor.value = data.hairColor;
    if(data.hairStyle) hairStyle.value = data.hairStyle;
    if(data.eyeColor) eyeColor.value = data.eyeColor;
    if(data.browStyle) browStyle.value = data.browStyle;
    if(data.mouthStyle) mouthStyle.value = data.mouthStyle;
    if(data.extra) extra.value = data.extra;
    if(typeof data.glasses === 'boolean') glasses.checked = data.glasses;
    if(data.name) document.getElementById('name').value = data.name;
    updateAvatar();
    alert('تم استيراد الإعدادات');
  }catch(e){ alert('JSON غير صالح') }
});

/* reset */
document.getElementById('reset').addEventListener('click', ()=>{
  skin.value = '#e6bf97';
  hairColor.value = '#3b2416';
  hairStyle.value = 'side';
  eyeColor.value = '#3b2b20';
  browStyle.value = 'normal';
  mouthStyle.value = 'smile';
  extra.value = 'none';
  glasses.checked = false;
  document.getElementById('name').value = '';
  updateAvatar();
});
</script>
</body>
</html>
